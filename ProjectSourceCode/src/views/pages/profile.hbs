{{> navbar}}

<div class="container mt-5">
  <div class="card p-4 shadow-sm" style="background-color: #f8f9fa;">
    <h3 class="mb-4 fw-bold">Profile Settings</h3>

    <div class="d-flex flex-column flex-md-row align-items-center mb-4">
      <img src="./src/resources/img/default_profile.png"
        alt="{{user.displayName}}'s Profile Picture" class="rounded mb-3 mb-md-0 me-md-4"
        style="width:150px; height:150px; object-fit:cover; border:2px solid #ccc;" />
      <form action="/profile/upload-picture" method="POST" enctype="multipart/form-data">
        <div class="d-flex flex-column">
          <input type="file" name="profilePicture" accept="image/*" class="form-control mb-2" style="max-width:250px;">
          <button type="submit" class="btn btn-primary">Upload New Picture</button>
        </div>
      </form>
    </div>

    <div class="mb-4">
      <strong>Email:</strong> {{user.email}}
    </div>

    <form id="displayNameForm" class="d-flex align-items-center mb-5">
      <label for="displayName" class="form-label me-2 fw-semibold mb-0">Display Name</label>
      <input type="text" id="displayName" name="displayName" class="form-control me-2" value="{{user.displayName}}"
        style="max-width:300px;">
      <button type="submit" class="btn btn-success">Save Display Name</button>
    </form>

    <h5 class="fw-bold mb-3">Followed Artists</h5>
    {{#if user.following}}
    <div class="row">
      {{#each user.following}}
      <div class="col-6 col-md-3 mb-3">
        <div class="card h-100 position-relative shadow-sm">
          <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
            onclick="removeArtist('{{this.id}}')">
            <i class="fas fa-times"></i>
          </button>
          <img src="{{#if this.image}}{{this.image}}{{else}}/images/placeholder.png{{/if}}" alt="{{this.name}}"
            class="card-img-top" style="height:120px; object-fit:cover;">
          <div class="card-body text-center">
            <h6 class="card-title mb-0">{{this.name}}</h6>
            {{#if this.type}}<p class="mb-1 text-muted small">{{this.type}}</p>{{/if}}
            <a href="{{this.link}}" class="btn btn-outline-primary btn-sm mt-2">View on Ticketmaster</a>
          </div>
        </div>
      </div>
      {{/each}}
    </div>
    {{else}}
    <p class="text-muted">You are not following any artists.</p>
    {{/if}}

    <div class="card mt-5 mb-4">
      <div class="card-body">
        <h5 class="card-title">Change Password</h5>
        <form id="changePasswordForm" method="POST" action="/profile/change-password">
          <div class="mb-3 row align-items-center">
            <label for="currentPassword" class="col-sm-4 col-form-label">Current Password</label>
            <div class="col-sm-8 d-flex">
              <input type="password" class="form-control me-2" id="currentPassword" name="currentPassword" required>
              <button type="button" class="btn btn-outline-secondary btn-sm toggle-password"
                data-target="#currentPassword">Show</button>
            </div>
          </div>

          <div class="mb-3 row align-items-center">
            <label for="newPassword" class="col-sm-4 col-form-label">New Password</label>
            <div class="col-sm-8 d-flex">
              <input type="password" class="form-control me-2" id="newPassword" name="newPassword" required>
              <button type="button" class="btn btn-outline-secondary btn-sm toggle-password"
                data-target="#newPassword">Show</button>
            </div>
          </div>

          <div class="mb-3 row align-items-center">
            <label for="confirmPassword" class="col-sm-4 col-form-label">Confirm New Password</label>
            <div class="col-sm-8 d-flex">
              <input type="password" class="form-control me-2" id="confirmPassword" name="confirmPassword" required>
              <button type="button" class="btn btn-outline-secondary btn-sm toggle-password"
                data-target="#confirmPassword">Show</button>
            </div>
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-primary">Change Password</button>
          </div>
        </form>
      </div>
    </div>
      <div class="container mt-3 mb-5">
      <div class="d-flex justify-content-center">
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('click', function (e) {
    if (!e.target.classList.contains('toggle-password')) return;
    var targetSelector = e.target.getAttribute('data-target');
    var input = document.querySelector(targetSelector);
    if (!input) return;
    if (input.type === 'password') {
      input.type = 'text';
      e.target.textContent = 'Hide';
    } else {
      input.type = 'password';
      e.target.textContent = 'Show';
    }
  });

  function removeArtist(artistId) {
    if (confirm("Are you sure you want to unfollow this artist?")) {
      fetch(`/profile/unfollow/${artistId}`, { method: "POST" })
        .then(res => res.json())
        .then(() => location.reload())
        .catch(err => console.error(err));
    }
  }

  document.getElementById("displayNameForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const newName = document.getElementById("displayName").value;

    fetch("/profile/update-name", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ displayName: newName })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        //alert("Display name updated!");
      }
    })
    .catch(err => console.error(err));
  });
</script>

{{> message}}